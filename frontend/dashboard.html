<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AutoGest - Dashboard Profissional</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="sidebar">
    <h2>AutoGest</h2>
    <p onclick="location.reload()">üìä Dashboard</p>
    <p onclick="abrirModal()">‚ûï Novo Ve√≠culo</p>
    <p onclick="logout()" style="color: #ff4d6d; margin-top: 50px;">üö™ Sair</p>
</div>

<div class="content">
    <h1>Gest√£o de Estoque</h1>

    <div id="cards-container" class="dashboard-grid"></div>

    <div class="stock-container" style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="consultaPlaca" placeholder="Placa para consulta SERPRO" style="width: 250px; padding: 10px; border-radius: 5px; border: none;">
        <button class="btn-renave" onclick="consultarRENAVE()">üîç Consultar RENAVE</button>
    </div>

    <div class="stock-container">
        <h2>üöó Ve√≠culos em Estoque</h2>
        <table>
            <thead><tr><th>Marca/Modelo</th><th>Placa</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
            <tbody id="lista-estoque"></tbody>
        </table>
    </div>
</div>

<div id="modalVeiculo" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Cadastrar Ve√≠culo</h2>
        <form id="formVeiculo">
            <input type="text" id="marca" placeholder="Marca" required>
            <input type="text" id="modelo" placeholder="Modelo" required>
            <input type="text" id="placa" placeholder="Placa" required>
            <input type="number" id="valor" placeholder="Pre√ßo" required>
            <button type="submit" style="width:100%; background:#e94560; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Salvar</button>
            <p onclick="fecharModal()" style="text-align:center; cursor:pointer; color:#aaa; margin-top:10px;">Cancelar</p>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://autogest-backend-ikmb.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    async function atualizarTela() {
        try {
            const resD = await fetch(`${API_URL}/dashboard`, { headers: { "Authorization": `Bearer ${token}` } });
            const d = await resD.json();
            document.getElementById("cards-container").innerHTML = `
                <div class="card"><h3>${d.total_veiculos || 0}</h3><p>Total Ve√≠culos</p></div>
                <div class="card"><h3>R$ ${(d.valor_total || 0).toLocaleString('pt-BR')}</h3><p>Patrim√¥nio</p></div>
            `;

            const resV = await fetch(`${API_URL}/veiculos`, { headers: { "Authorization": `Bearer ${token}` } });
            const veiculos = await resV.json();
            document.getElementById("lista-estoque").innerHTML = veiculos.map(v => `
                <tr>
                    <td><strong>${v.marca}</strong> ${v.modelo}</td>
                    <td>${v.placa}</td>
                    <td>R$ ${v.valor.toLocaleString('pt-BR')}</td>
                    <td><button class="btn-delete" onclick="excluir(${v.id})">üóëÔ∏è Remover</button></td>
                </tr>
            `).join("");
        } catch (e) { console.error(e); }
    }

    async function consultarRENAVE() {
        const placa = document.getElementById("consultaPlaca").value;
        if (!placa) return alert("Insira uma placa");

        const res = await fetch(`${API_URL}/renave/consultar/${placa}`, { headers: { "Authorization": `Bearer ${token}` } });
        const dados = await res.json();

        if (res.ok) {
            abrirModal();
            document.getElementById("marca").value = dados.marca;
            document.getElementById("modelo").value = dados.modelo;
            document.getElementById("placa").value = dados.placa;
            alert("Dados importados do SERPRO!");
        }
    }

    async function excluir(id) {
        if (!confirm("Excluir ve√≠culo?")) return;
        const res = await fetch(`${API_URL}/veiculos/${id}`, { method: "DELETE", headers: { "Authorization": `Bearer ${token}` } });
        if (res.ok) atualizarTela();
    }

    document.getElementById("formVeiculo").onsubmit = async (e) => {
        e.preventDefault();
        const body = {
            marca: document.getElementById("marca").value,
            modelo: document.getElementById("modelo").value,
            placa: document.getElementById("placa").value,
            valor: parseFloat(document.getElementById("valor").value)
        };
        const res = await fetch(`${API_URL}/veiculos`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify(body)
        });
        if (res.ok) { fecharModal(); atualizarTela(); document.getElementById("formVeiculo").reset(); }
    };

    function abrirModal() { document.getElementById("modalVeiculo").style.display = "flex"; }
    function fecharModal() { document.getElementById("modalVeiculo").style.display = "none"; }
    function logout() { localStorage.removeItem("token"); window.location.href = "login.html"; }

    atualizarTela();
</script>
</body>
</html>