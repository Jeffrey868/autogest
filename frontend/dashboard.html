<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AutoGest - Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="sidebar">
    <h2>AutoGest</h2>
    <p onclick="location.reload()">üìä Dashboard</p>
    <p onclick="abrirModal()">‚ûï Novo Ve√≠culo</p>
    <p onclick="window.location.href='configuracoes.html'">‚öôÔ∏è Configura√ß√µes</p>
    <p onclick="logout()" style="color: #ff4d6d; margin-top: 50px;">üö™ Sair</p>
</div>

<div class="content">
    <h1>Gest√£o de Estoque</h1>
    <div id="cards-container" class="dashboard-grid"></div>

    <div class="stock-container">
        <table>
            <thead><tr><th>Ve√≠culo</th><th>Placa</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
            <tbody id="lista-veiculos"></tbody>
        </table>
    </div>
</div>

<div id="modalVeiculo" class="modal">
    <div class="modal-content">
        <h3>Cadastrar Ve√≠culo</h3>
        <input type="text" id="marca" placeholder="Marca">
        <input type="text" id="modelo" placeholder="Modelo">
        <input type="text" id="placa" placeholder="Placa">
        <input type="number" id="valor" placeholder="Valor (R$)">
        <button onclick="salvarVeiculo()">Salvar</button>
        <button onclick="fecharModal()" style="background:#666">Cancelar</button>
    </div>
</div>

<script>
    const API_URL = "https://autogest-backend-ikmb.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "index.html";

    async function atualizarTela() {
        const resDash = await fetch(`${API_URL}/dashboard`, { headers: { "Authorization": `Bearer ${token}` } });
        const dash = await resDash.json();

        document.getElementById("cards-container").innerHTML = `
            <div class="card"><h3>${dash.total_veiculos}</h3><p>Ve√≠culos no P√°tio</p></div>
            <div class="card"><h3>R$ ${dash.valor_total.toLocaleString()}</h3><p>Patrim√¥nio em Estoque</p></div>
        `;

        const resLista = await fetch(`${API_URL}/veiculos`, { headers: { "Authorization": `Bearer ${token}` } });
        const veiculos = await resLista.json();
        const tbody = document.getElementById("lista-veiculos");
        tbody.innerHTML = veiculos.map(v => `
            <tr>
                <td>${v.marca} ${v.modelo}</td>
                <td>${v.placa}</td>
                <td>R$ ${v.valor.toLocaleString()}</td>
                <td>
                    <button onclick="vender(${v.id})" style="background:#4ecca3; color:white; border:none; padding:5px; cursor:pointer">‚úîÔ∏è Vender</button>
                    <button onclick="excluir(${v.id})" style="background:#ff4d6d; color:white; border:none; padding:5px; cursor:pointer">üóëÔ∏è</button>
                </td>
            </tr>
        `).join("");
    }

    async function vender(id) {
        if(confirm("Confirmar venda?")) {
            await fetch(`${API_URL}/veiculos/${id}/vender`, { method: "PUT", headers: { "Authorization": `Bearer ${token}` } });
            atualizarTela();
        }
    }

    async function excluir(id) {
        if(confirm("Deseja excluir permanentemente?")) {
            await fetch(`${API_URL}/veiculos/${id}`, { method: "DELETE", headers: { "Authorization": `Bearer ${token}` } });
            atualizarTela();
        }
    }

    async function salvarVeiculo() {
        const body = {
            marca: document.getElementById("marca").value,
            modelo: document.getElementById("modelo").value,
            placa: document.getElementById("placa").value,
            valor: parseFloat(document.getElementById("valor").value)
        };
        await fetch(`${API_URL}/veiculos`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify(body)
        });
        fecharModal();
        atualizarTela();
    }

    function abrirModal() { document.getElementById("modalVeiculo").style.display = "flex"; }
    function fecharModal() { document.getElementById("modalVeiculo").style.display = "none"; }
    function logout() { localStorage.removeItem("token"); window.location.href = "index.html"; }

    atualizarTela();
</script>
</body>
</html>