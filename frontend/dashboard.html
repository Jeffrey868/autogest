<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - AutoGest</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="sidebar">
    <h2>AutoGest</h2>
    <p onclick="location.reload()">ðŸ”„ Dashboard</p>
    <p onclick="abrirModal()">ðŸš— VeÃ­culos</p>
    <p>ðŸ“„ RENAVE</p>
    <p onclick="logout()" style="color: #ff4d6d; margin-top: 30px; font-weight: bold;">ðŸšª Sair</p>
</div>

<div class="content">
    <h1>Bem-vindo ao AutoGest</h1>
    <div id="cards-container" class="dashboard-grid">
        <div class="loading">Sincronizando com o servidor...</div>
    </div>
</div>

<div id="modalVeiculo" class="modal">
    <div class="modal-content">
        <h2>Novo VeÃ­culo</h2>
        <form id="formCadastro">
            <input type="text" id="marca" placeholder="Marca" required>
            <input type="text" id="modelo" placeholder="Modelo" required>
            <input type="text" id="placa" placeholder="Placa" required>
            <input type="number" id="valor" placeholder="Valor (R$)" step="0.01" required>
            <button type="submit" class="btn-save">Cadastrar</button>
            <div class="btn-cancel" onclick="fecharModal()">Cancelar</div>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://autogest-backend-ikmb.onrender.com";

    async function carregarDados() {
        const token = localStorage.getItem("token");
        if (!token) { window.location.href = "login.html"; return; }

        try {
            const res = await fetch(`${API_URL}/dashboard`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const data = await res.json();

            document.getElementById("cards-container").innerHTML = `
                <div class="card"><h3>${data.total_veiculos || 0}</h3><p>Total</p></div>
                <div class="card"><h3>${data.em_estoque || 0}</h3><p>Em Estoque</p></div>
                <div class="card"><h3>${data.vendidos || 0}</h3><p>Vendidos</p></div>
                <div class="card"><h3>R$ ${(data.valor_total || 0).toLocaleString('pt-BR')}</h3><p>PatrimÃ´nio</p></div>
            `;
        } catch (e) {
            document.getElementById("cards-container").innerHTML = "Erro ao carregar.";
        }
    }

    // Controle do Modal
    function abrirModal() { document.getElementById("modalVeiculo").style.display = "flex"; }
    function fecharModal() { document.getElementById("modalVeiculo").style.display = "none"; }

    // Envio do Cadastro
    document.getElementById("formCadastro").onsubmit = async (e) => {
        e.preventDefault();
        const token = localStorage.getItem("token");
        const body = {
            marca: document.getElementById("marca").value,
            modelo: document.getElementById("modelo").value,
            placa: document.getElementById("placa").value,
            valor: parseFloat(document.getElementById("valor").value)
        };

        const res = await fetch(`${API_URL}/veiculos`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert("Sucesso!");
            fecharModal();
            carregarDados();
        }
    };

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
    }

    carregarDados();
</script>

</body>
</html>