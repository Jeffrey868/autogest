<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGest - Gest√£o de Estoque</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="sidebar">
    <h2>AutoGest</h2>
    <p onclick="location.reload()">üìä Dashboard</p>
    <p onclick="abrirModal()">‚ûï Novo Ve√≠culo</p>
    <p onclick="logout()" style="color: #ff4d6d; margin-top: 50px; font-weight: bold;">üö™ Sair</p>
</div>

<div class="content">
    <h1>Gest√£o de Estoque</h1>

    <div id="cards-container" class="dashboard-grid">
        <div class="loading">Sincronizando dados...</div>
    </div>

    <div class="stock-container">
        <h2>üöó Ve√≠culos em Estoque</h2>
        <table>
            <thead>
                <tr>
                    <th>Marca/Modelo</th>
                    <th>Placa</th>
                    <th>Valor</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-estoque">
                </tbody>
        </table>
    </div>
</div>

<div id="modalVeiculo" class="modal">
    <div class="modal-content">
        <h2>Cadastrar Ve√≠culo</h2>
        <form id="formVeiculo">
            <input type="text" id="marca" placeholder="Marca (ex: Toyota)" required>
            <input type="text" id="modelo" placeholder="Modelo (ex: Corolla)" required>
            <input type="text" id="placa" placeholder="Placa" required>
            <input type="number" id="valor" placeholder="Pre√ßo de Venda (R$)" step="0.01" required>
            <button type="submit" class="btn-save" style="width:100%; background:#e94560; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Salvar no Estoque</button>
            <p onclick="fecharModal()" style="text-align:center; cursor:pointer; color:#aaa; margin-top:15px;">Cancelar</p>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://autogest-backend-ikmb.onrender.com";
    const token = localStorage.getItem("token");

    // Redireciona se n√£o houver login
    if (!token) {
        window.location.href = "login.html";
    }

    // Fun√ß√£o principal para carregar dados e atualizar a interface
    async function carregarTudo() {
        try {
            // 1. Atualiza os Cards (Patrim√¥nio e Total)
            const resDash = await fetch(`${API_URL}/dashboard`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const d = await resDash.json();

            document.getElementById("cards-container").innerHTML = `
                <div class="card">
                    <h3>${d.total_veiculos || 0}</h3>
                    <p>Total Ve√≠culos</p>
                </div>
                <div class="card">
                    <h3>R$ ${(d.valor_total || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h3>
                    <p>Patrim√¥nio</p>
                </div>
            `;

            // 2. Atualiza a Tabela de Estoque
            const resVeic = await fetch(`${API_URL}/veiculos`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const veiculos = await resVeic.json();

            const tabela = document.getElementById("lista-estoque");
            tabela.innerHTML = veiculos.map(v => `
                <tr>
                    <td><strong>${v.marca}</strong> ${v.modelo}</td>
                    <td>${v.placa}</td>
                    <td>R$ ${v.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>
                        <button class="btn-delete" onclick="excluirVeiculo(${v.id})" style="background:#e94560; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">üóëÔ∏è Remover</button>
                    </td>
                </tr>
            `).join("");

        } catch (error) {
            console.error("Erro ao carregar dados:", error);
        }
    }

    // Fun√ß√£o para Excluir Ve√≠culo
    async function excluirVeiculo(id) {
        if (!confirm("Deseja realmente remover este ve√≠culo? Esta a√ß√£o atualizar√° o patrim√¥nio imediatamente.")) return;

        try {
            const res = await fetch(`${API_URL}/veiculos/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                // RECARREGA TUDO AP√ìS EXCLUIR
                await carregarTudo();
            } else {
                alert("Erro ao excluir o ve√≠culo do servidor.");
            }
        } catch (err) {
            alert("Erro de conex√£o.");
        }
    }

    // Envio do formul√°rio de cadastro
    document.getElementById("formVeiculo").onsubmit = async (e) => {
        e.preventDefault();

        const dados = {
            marca: document.getElementById("marca").value,
            modelo: document.getElementById("modelo").value,
            placa: document.getElementById("placa").value,
            valor: parseFloat(document.getElementById("valor").value)
        };

        const res = await fetch(`${API_URL}/veiculos`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(dados)
        });

        if (res.ok) {
            fecharModal();
            document.getElementById("formVeiculo").reset();
            await carregarTudo(); // Recarrega para somar o novo valor
        }
    };

    // Fun√ß√µes de Interface
    function abrirModal() { document.getElementById("modalVeiculo").style.display = "flex"; }
    function fecharModal() { document.getElementById("modalVeiculo").style.display = "none"; }

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
    }

    // Inicializa√ß√£o
    carregarTudo();
</script>

</body>
</html>